<!DOCTYPE html>
<html lang="vi">
<head>
    <%- include('../layout/head') %>
    <title>Quản lý Kho thực phẩm</title>
</head>
<body>
    <div id="wrapper">
        <%- include('../layout/sidebar') %>
        <div id="content-wrapper" class="d-flex flex-column">
            <%- include('../layout/header') %>
            <div class="container-fluid">
                <% if(errors.length > 0){%>
                    <div class="alert alert-danger">
                        <%for(let item of errors){%>
                            <div><%-item%></div>
                        <%}%>
                    </div>
                <% } %>

                <!-- Header -->
                <div class="d-sm-flex align-items-center justify-content-between mb-4">
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-warehouse text-primary"></i> Quản lý Kho thực phẩm
                    </h1>
                    <button class="btn btn-primary btn-sm" onclick="openCreateWarehouse()">
                        <i class="fas fa-plus"></i> Tạo kho mới
                    </button>
                </div>

                <!-- Warehouses List -->
                <div class="row">
                    <% if(warehouses.length === 0) { %>
                        <div class="col-12">
                            <div class="card shadow">
                                <div class="card-body text-center py-5">
                                    <i class="fas fa-warehouse fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">Chưa có kho nào</h5>
                                    <p class="text-muted">Tạo kho đầu tiên để bắt đầu quản lý thực phẩm</p>
                                    <button class="btn btn-primary" onclick="openCreateWarehouse()">
                                        <i class="fas fa-plus"></i> Tạo kho mới
                                    </button>
                                </div>
                            </div>
                        </div>
                    <% } else { %>
                        <% warehouses.forEach(warehouse => { %>
                            <div class="col-xl-4 col-md-6 mb-4">
                                <div class="card border-left-primary shadow h-100">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                    <%= warehouse.name %>
                                                </div>
                                                <% if(warehouse.location) { %>
                                                    <div class="text-xs text-muted mb-2">
                                                        <i class="fas fa-map-marker-alt"></i> <%= warehouse.location %>
                                                    </div>
                                                <% } %>
                                                <% if(warehouse.description) { %>
                                                    <div class="text-sm text-gray-700 mb-2">
                                                        <%= warehouse.description %>
                                                    </div>
                                                <% } %>
                                                <div class="text-xs text-muted">
                                                    Tạo bởi: <%= warehouse.created_by_name || 'N/A' %>
                                                </div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="fas fa-warehouse fa-2x text-gray-300"></i>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <div class="btn-group btn-group-sm w-100" role="group">
                                                <a href="/inventory/stock/<%= warehouse.id %>" class="btn btn-success">
                                                    <i class="fas fa-boxes"></i> Tồn kho
                                                </a>
                                                <a href="/inventory/receipt/create/<%= warehouse.id %>" class="btn btn-primary">
                                                    <i class="fas fa-arrow-down"></i> Nhập
                                                </a>
                                                <a href="/inventory/issue/create/<%= warehouse.id %>" class="btn btn-warning">
                                                    <i class="fas fa-arrow-up"></i> Xuất
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } %>
                </div>
            </div>
            <%- include('../layout/footer') %>
        </div>
    </div>

    <!-- Modal Create/Edit Warehouse -->
    <div class="modal fade" id="warehouseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tạo kho mới</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="warehouseForm">
                        <input type="hidden" id="warehouseId" name="id">
                        <div class="form-group">
                            <label for="warehouseName">Tên kho <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="warehouseName" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="warehouseLocation">Vị trí</label>
                            <input type="text" class="form-control" id="warehouseLocation" name="location">
                        </div>
                        <div class="form-group">
                            <label for="warehouseDescription">Mô tả</label>
                            <textarea class="form-control" id="warehouseDescription" name="description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveWarehouse()">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openCreateWarehouse() {
            $('#warehouseId').val('');
            $('#warehouseName').val('');
            $('#warehouseLocation').val('');
            $('#warehouseDescription').val('');
            $('#warehouseModal .modal-title').text('Tạo kho mới');
            $('#warehouseModal').modal('show');
        }

        function saveWarehouse() {
            const formData = {
                id: $('#warehouseId').val(),
                name: $('#warehouseName').val(),
                location: $('#warehouseLocation').val(),
                description: $('#warehouseDescription').val()
            };

            if (!formData.name) {
                Swal.fire('Lỗi', 'Vui lòng nhập tên kho', 'error');
                return;
            }

            $.ajax({
                url: '/inventory/warehouse/upsert',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công',
                            text: formData.id ? 'Cập nhật kho thành công' : 'Tạo kho thành công'
                        }).then(() => {
                            window.location.reload();
                        });
                    } else {
                        Swal.fire('Lỗi', response.message, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    Swal.fire('Lỗi', 'Có lỗi xảy ra: ' + error, 'error');
                }
            });
        }
    </script>
</body>
</html>

