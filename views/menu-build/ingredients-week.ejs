<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../layout/head') %>
    <title>Tính nguyên liệu - Tuần <%= week %> - <%= menuBuild.name %></title>
</head>
<body>
    <div id="wrapper">
        <%- include('../layout/sidebar') %>
        <div id="content-wrapper" class="d-flex flex-column">
            <%- include('../layout/header') %>
            <% if(errors.length > 0){%>
                <div class="container">
                    <div class="box mt-3">
                        <%for(let item of errors){%>
                            <div><%-JSON.stringify(item)%></div>
                        <%}%>
                    </div>
                </div>
            <% }else{ %>
                <div class="container-fluid">
                    <!-- Header -->
                    <div class="d-sm-flex align-items-center justify-content-between mb-4">
                        <h1 class="h3 mb-0 text-gray-800">
                            <i class="fas fa-calculator text-primary"></i>
                            Tính nguyên liệu: <%= menuBuild.name %> - Tuần <%= week %>
                        </h1>
                        <div class="d-flex gap-2">
                            <button class="btn btn-secondary btn-sm" onclick="window.close()">
                                <i class="fas fa-arrow-left"></i> Đóng
                            </button>
                            <button class="btn btn-success btn-sm" onclick="exportToExcel()">
                                <i class="fas fa-file-excel"></i> Xuất Excel
                            </button>
                        </div>
                    </div>

                    <!-- Summary Card -->
                    <div class="row mb-4">
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-primary shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                Tổng số loại thực phẩm</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800"><%= ingredientsList.length %></div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-list fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-success shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                Tổng chi phí ước tính</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                                <%= ingredientsList.reduce((sum, item) => sum + item.total_cost, 0).toLocaleString('vi-VN') %> VNĐ
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-dollar-sign fa-2x text-gray-30"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-info shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                                Tổng khối lượng thực đơn</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                                <%= (ingredientsList.reduce((sum, item) => sum + item.total_weight, 0) / 1000).toFixed(2) %> kg
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-weight fa-2x text-gray-30"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-warning shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                                Tổng khối lượng cần mua</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                                <%= (ingredientsList.reduce((sum, item) => sum + item.purchase_weight, 0) / 100).toFixed(2) %> kg
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-shopping-cart fa-2x text-gray-30"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ingredients Table -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-table"></i> Danh sách nguyên liệu cả tuần
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover" id="ingredientsTable">
                                    <thead class="thead-light">
                                        <tr>
                                            <th width="5%">STT</th>
                                            <th width="20%">Tên thực phẩm</th>
                                            <th width="18%">Các bữa ăn trong tuần</th>
                                            <th width="10%" class="text-right">KL thực đơn (g)</th>
                                            <th width="10%" class="text-right">Tỷ lệ ăn được (%)</th>
                                            <th width="10%" class="text-right">KL cần mua (g)</th>
                                            <th width="10%" class="text-right">Đơn giá (VNĐ/kg)</th>
                                            <th width="12%" class="text-right">Thành tiền (VNĐ)</th>
                                            <th width="8%">Nguồn giá</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if(ingredientsList.length === 0) { %>
                                            <tr>
                                                <td colspan="9" class="text-center text-muted">
                                                    <i class="fas fa-info-circle"></i> Chưa có nguyên liệu nào trong tuần
                                                </td>
                                            </tr>
                                        <% } else { %>
                                            <% ingredientsList.forEach((item, index) => { %>
                                                <tr>
                                                    <td class="text-center"><%= index + 1 %></td>
                                                    <td><%= item.name %></td>
                                                    <td><small><%= item.meal_times %></small></td>
                                                    <td class="text-right"><%= item.total_weight.toFixed(2) %></td>
                                                    <td class="text-right"><%= item.edible.toFixed(0) %></td>
                                                    <td class="text-right font-weight-bold text-warning">
                                                        <%= item.purchase_weight.toFixed(2) %>
                                                    </td>
                                                    <td class="text-right">
                                                        <% if(item.avg_price && item.avg_price > 0) { %>
                                                            <%= item.avg_price.toLocaleString('vi-VN') %>
                                                        <% } else { %>
                                                            <span class="text-muted">-</span>
                                                        <% } %>
                                                    </td>
                                                    <td class="text-right font-weight-bold text-success">
                                                        <% if(item.total_cost > 0) { %>
                                                            <%= item.total_cost.toLocaleString('vi-VN') %>
                                                        <% } else { %>
                                                            <span class="text-muted">-</span>
                                                        <% } %>
                                                    </td>
                                                    <td class="text-center">
                                                        <% if(item.is_reference) { %>
                                                            <span class="badge badge-secondary badge-sm" title="Giá tham khảo">TK</span>
                                                        <% } else { %>
                                                            <span class="badge badge-success badge-sm" title="Giá nhập kho FIFO">NK</span>
                                                        <% } %>
                                                    </td>
                                                </tr>
                                            <% }); %>
                                        <% } %>
                                    </tbody>
                                    <% if(ingredientsList.length > 0) { %>
                                        <tfoot class="thead-light">
                                            <tr>
                                                <th colspan="3" class="text-right">TỔNG CỘNG:</th>
                                                <th class="text-right">
                                                    <%= ingredientsList.reduce((sum, item) => sum + item.total_weight, 0).toFixed(2) %> g
                                                </th>
                                                <th></th>
                                                <th class="text-right font-weight-bold text-warning">
                                                    <%= ingredientsList.reduce((sum, item) => sum + item.purchase_weight, 0).toFixed(2) %> g
                                                </th>
                                                <th></th>
                                                <th class="text-right font-weight-bold text-success">
                                                    <%= ingredientsList.reduce((sum, item) => sum + item.total_cost, 0).toLocaleString('vi-VN') %> VNĐ
                                                </th>
                                                <th></th>
                                            </tr>
                                        </tfoot>
                                    <% } %>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Note -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading"><i class="fas fa-info-circle"></i> Ghi chú:</h6>
                        <ul class="mb-0">
                            <li><strong>KL thực đơn:</strong> Tổng khối lượng thực phẩm sau khi chế biến (đã loại bỏ phần không ăn được) trong cả tuần</li>
                            <li><strong>Tỷ lệ ăn được:</strong> Phần trăm khối lượng có thể ăn được của thực phẩm (edible %)</li>
                            <li><strong>KL cần mua:</strong> Tổng khối lượng cần đi chợ cho cả tuần = KL thực đơn / (Tỷ lệ ăn được / 100)</li>
                            <li><strong>Đơn giá:</strong> Giá trung bình tính theo FIFO từ nhập kho hoặc giá tham khảo</li>
                            <li><strong>Thành tiền:</strong> Chi phí = (KL cần mua / 1000) × Đơn giá (VNĐ/kg)</li>
                            <li><strong>Nguồn giá:</strong>
                                <span class="badge badge-success">NK</span> = Giá nhập kho thực tế (FIFO) |
                                <span class="badge badge-secondary">TK</span> = Giá tham khảo (chưa có nhập kho)
                            </li>
                            <li><strong>Các bữa ăn:</strong> Danh sách các ngày và giờ ăn trong tuần mà thực phẩm này được sử dụng</li>
                        </ul>
                    </div>
                </div>
            <% } %>
            <%- include('../layout/footer') %>
        </div>
    </div>

    <script src="/vendor/exceljs/polyfill.js"></script>
    <script src="/vendor/exceljs/exceljs.min.js"></script>
    <script>
        const menuBuildName = '<%= menuBuild ? menuBuild.name : "" %>';
        const weekNumber = <%= week %>;
        const ingredientsList = <%- JSON.stringify(ingredientsList) %>;

        function exportToExcel() {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Nguyên liệu cả tuần');

            // Title
            worksheet.mergeCells('A1:I1');
            worksheet.getCell('A1').value = `TÍNH NGUYÊN LIỆU CẢ TUẦN - ${menuBuildName} - Tuần ${weekNumber}`;
            worksheet.getCell('A1').font = { size: 16, bold: true };
            worksheet.getCell('A1').alignment = { horizontal: 'center', vertical: 'middle' };

            // Headers
            worksheet.addRow([]);
            const headerRow = worksheet.addRow([
                'STT', 'Tên thực phẩm', 'Các bữa ăn trong tuần', 'KL thực đơn (g)', 
                'Tỷ lệ ăn được (%)', 'KL cần mua (g)', 'Đơn giá (VNĐ/kg)', 'Thành tiền (VNĐ)', 'Nguồn giá'
            ]);
            headerRow.font = { bold: true };
            headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD3D3D3' } };

            // Data
            ingredientsList.forEach((item, index) => {
                worksheet.addRow([
                    index + 1,
                    item.name,
                    item.meal_times,
                    item.total_weight.toFixed(2),
                    item.edible.toFixed(0),
                    item.purchase_weight.toFixed(2),
                    item.avg_price > 0 ? item.avg_price : '',
                    item.total_cost > 0 ? item.total_cost : '',
                    item.is_reference ? 'TK' : 'NK'
                ]);
            });

            // Total row
            const totalRow = worksheet.addRow([
                '', '', 'TỔNG CỘNG:',
                ingredientsList.reduce((sum, item) => sum + item.total_weight, 0).toFixed(2),
                '',
                ingredientsList.reduce((sum, item) => sum + item.purchase_weight, 0).toFixed(2),
                '',
                ingredientsList.reduce((sum, item) => sum + item.total_cost, 0),
                ''
            ]);
            totalRow.font = { bold: true };
            totalRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFEB3B' } };

            // Column widths
            worksheet.columns = [
                { width: 8 }, { width: 30 }, { width: 25 }, { width: 15 },
                { width: 15 }, { width: 15 }, { width: 18 }, { width: 18 }, { width: 10 }
            ];

            // Export
            workbook.xlsx.writeBuffer().then(buffer => {
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Nguyen_lieu_ca_tuan_${menuBuildName}_Tuan${weekNumber}.xlsx`;
                a.click();
                window.URL.revokeObjectURL(url);
            });
        }
    </script>
</body>
</html>
