<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../layout/head') %>
        <title>Chi tiết thực đơn - Tuần <%= week %> - <%= dayName %></title>
</head>

<body>

    <!-- Page Wrapper -->
    <div id="wrapper">
        <%- include('../layout/sidebar') %>

            <!-- Content Wrapper -->
            <div id="content-wrapper" class="d-flex flex-column">
                <%- include('../layout/header') %>
                    <!-- Begin Page Content -->
                    <% if(errors.length> 0){%>
                        <div class="container">
                            <div class="box mt-3">
                                <%for(let item of errors){%>
                                    <div><%-JSON.stringify(item)%></div>
                                    <%}%>
                            </div>
                        </div>
                        <% }else{ %>
                            <div class="container-fluid">
                                <!-- Header với điều hướng -->
                                <div class="d-sm-flex align-items-center justify-content-between mb-4">
                                    <h1 class="h3 mb-0 text-gray-800">
                                        Chi tiết: <%= menuBuild.name %> - Tuần <%= week %> - <%= dayName %>
                                    </h1>
                                    <div class="d-flex">
                                        <button class="btn btn-secondary btn-sm mr-2" onclick="window.close()">
                                            <i class="fas fa-arrow-left fa-sm text-white-50"></i> Đóng
                                        </button>
                                    </div>
                                </div>

                                <div class="card shadow mb-4">
                                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                        <div class="d-flex align-items-center flex-grow-1">
                                            <h5 class="text-primary font-weight-bold mb-0">
                                                <%= menuBuild.name %> - Tuần <%= week %> - <%= dayName %>
                                            </h5>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <button title="Lưu thực đơn" class="btn btn-success btn-circle" onclick="saveMenuBuildDay()">
                                                <i class="fa-solid fa-floppy-disk"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body px-0">
                                        <div class="card shadow mb-4">
                                            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                                <h6 class="text-primary mb-0">Thêm thực phẩm</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row g-2 align-items-center">
                                                    <div class="col-12 col-md-3 d-flex align-items-center">
                                                        <label class="col-form-label col-md-auto fw-bold mt-2"
                                                            for="menuTime_id">Chọn giờ ăn</label>
                                                        <div class="col-form-body col-md w-100">
                                                            <div class="form-control-has-addon">
                                                                <div id="menuTime_id" data-plugin="virtual-select" data-config='{"placeholder":"Chọn giờ ăn"}'
                                                        data-options='<%=JSON.stringify(menuTimes.map(s => ({label: s.name, value: s.id})))%>'></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Chọn món ăn (course) trong giờ ăn -->
                                                    <div class="col-12 col-md-3 d-flex align-items-center">
                                                        <label class="col-form-label col-md-auto fw-bold" for="course_id">Món ăn</label>
                                                        <div class="col-form-body col-md w-100">
                                                            <div class="form-control-has-addon">
                                                                <div id="course_id" data-plugin="virtual-select" data-config='{"placeholder":"Chọn món trong giờ ăn"}'></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Filter cho thực phẩm -->
                                                    <div class="col-12 col-md-3 d-flex align-items-center">
                                                        <label class="col-form-label col-md-auto fw-bold" for="food_type">Loại thực phẩm</label>
                                                        <div class="col-form-body col-md w-100">
                                                            <select id="food_type" name="food_type" class="form-control" onchange="updateFoodDropdown('food_name')">
                                                                <option value="">Tất cả</option>
                                                                <option value="raw">Sống</option>
                                                                <option value="cooked">Chín ĐP</option>
                                                                <option value="cooked_vdd">Chín VDD</option>
                                                                <option value="milk">Sữa</option>
                                                                <option value="ddd">Dịch DD</option>
                                                                <option value="cake">Bánh/kẹo/đồ uống</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-12 col-md-3 d-flex align-items-center">
                                                        <label class="col-form-label col-md-auto fw-bold" for="food_year">Năm dữ liệu</label>
                                                        <div class="col-form-body col-md w-100">
                                                            <select id="food_year" name="food_year" class="form-control" onchange="updateFoodDropdown('food_name')">
                                                                <option value="">Tất cả</option>
                                                                <option value="2000">2000</option>
                                                                <option value="2017">2017</option>
                                                                <option value="2025">2025</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="row g-2 align-items-center">
                                                    <div class="col-12 col-md-8 d-flex align-items-center">
                                                        <label class="col-form-label col-md-auto fw-bold mt-2"
                                                            for="food_name">Thực
                                                            phẩm</label>
                                                        <div class="col-form-body col-md w-100">
                                                            <div class="form-control-has-addon">
                                                                <div id="food_name"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-12 col-md-4">
                                                        <div class="input-group">
                                                                <input type="number" class="form-control form-control-title p-1"
                                                                    id="weight_food" placeholder="Khối lượng"
                                                                    data-initial-value="0">
                                                                                                                <button class="btn btn-primary" type="button"
                                                    onclick="addFoodToMenuAdmin()"
                                                    title="Thêm thực phẩm vào thực đơn">Thêm</button>
                                                            </div>
                                                    </div>
                                                </div>
                                                
                                            </div>
                                        </div>
                                        
                                        <!-- Card chọn món ăn -->
                                        <div class="card shadow mb-4">
                                            <div class="card-header py-3">
                                                <h6 class="text-primary mb-0">Thêm món ăn vào thực đơn</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row g-2 align-items-center">
                                                    <div class="col-12 col-md-4 d-flex align-items-center">
                                                        <label class="col-form-label col-md-auto fw-bold mt-2"
                                                            for="dish_menuTime_id">Chọn giờ ăn</label>
                                                        <div class="col-form-body col-md w-100">
                                                            <div class="form-control-has-addon">
                                                                <div id="dish_menuTime_id" data-plugin="virtual-select" data-config='{"placeholder":"Chọn giờ ăn"}'
                                                        data-options='<%=JSON.stringify(menuTimes.map(s => ({label: s.name, value: s.id})))%>'></div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-12 col-md-4 d-flex align-items-center">
                                                        <label class="col-form-label col-md-auto fw-bold mt-2"
                                                            for="dish_category">Loại món</label>
                                                        <div class="col-form-body col-md w-100">
                                                            <div class="form-control-has-addon">
                                                                <div id="dish_category" data-plugin="virtual-select" data-config='{"placeholder":"Chọn loại món"}'></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row g-2 align-items-center">
                                                    <div class="col-12 col-md-8 d-flex align-items-center">
                                                        <label class="col-form-label col-md-auto fw-bold mt-2"
                                                            for="dish_name">Món ăn</label>
                                                        <div class="col-form-body col-md w-100">
                                                            <div class="form-control-has-addon">
                                                                <div id="dish_name"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-12 col-md-4">
                                                        <div class="input-group">
                                                            <button class="btn btn-success" type="button"
                                                                onclick="addDishToMenu()"
                                                                title="Thêm món ăn vào thực đơn">Thêm món ăn</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Column Configuration Card -->
                                        <div class="card shadow mb-4" id="column-config-card" style="display: none;">
                                            <div class="card-header">
                                                <h6 class="m-0 font-weight-bold d-flex justify-content-between align-items-center">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <i class="fas fa-columns"></i> Chọn cột hiển thị
                                                    </div>
                                                    <button type="button" class="btn btn-sm btn-outline-primary float-right" onclick="toggleColumnSelector()">
                                                        <i class="fas fa-cog"></i>
                                                    </button>
                                                </h6>
                                            </div>
                                            <div class="card-body" id="column-selector">
                                                <!-- Column selector content will be generated by JavaScript -->
                                            </div>
                                        </div>

                                        <div class="card shadow mb-4">
                                            <div class="card-header py-3">
                                                <h6 class="text-primary mb-0">Thực đơn chi tiết</h6>
                                            </div>
                                            <div class="card-body px-0">
                                                <div class="row g-2 align-items-center">
                                                    <div class="table-responsive-xl table-responsive-flush mb-4" id="tb_menu"
                                                        style="width: 100%;display: none;">
                                                        <div class="table-responsive-inner px-3">
                                                            <table
                                                                class="table-2 table table-pe-x-3 mb-0 align-middle table-ds-booking table-bordered table-hover">
                                                                <thead class="text-center">
                                                                    <tr>
                                                                        <th class="text-center">Bữa ăn</th>
                                                                        <th class="text-center">Tên món ăn</th>
                                                                        <th class="text-center">Weight(g)</th>
                                                                        <th class="text-center">Energy(kcal)</th>
                                                                        <th class="text-center">Protein(g)</th>
                                                                        <th class="text-center">Fat(g)</th>
                                                                        <th class="text-center">Carbohydrate(g)</th>
                                                                        <th class="text-center">Thao tác</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>

                                                                </tbody>
                                                                <tfoot>
                                                                    <tr id="total-row" style="display: none;">
                                                                        <!-- Total row will be generated by JavaScript -->
                                                                    </tr>
                                                                </tfoot>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>


                                                <div class="d-flex gap-3 align-items-center justify-content-center mt-3">
                                                    <button class="btn btn-info" type="button" onclick="exportMenuExcel()">
                                                        <i class="fas fa-file-excel"></i>
                                                        Xuất Excel
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                <% } %>
                <%- include('../layout/footer') %>
            </div>
    </div>
    
    <!-- Thư viện ExcelJS để xuất Excel -->
    <script src="/vendor/exceljs/polyfill.js"></script>
    <script src="/vendor/exceljs/exceljs.min.js"></script>
    <script src="/js/column-config.js"></script>
    <script src="/js/menuExample.js?v=<%= assetVersion %>"></script>

    <script>
        // Hidden inputs for menu build info
        const menuBuildId = <%= menuBuild.id %>;
        const weekNumber = <%= week %>;
        const dayOfWeek = <%= day %>;

        // Khai báo global variables
        window.listMenuTime = <%- JSON.stringify(menuTimes) %>;

        // Convert dayDetails to menuExamine format
        window.menuExamine = [{
            id: 1,
            name: '<%= menuBuild.name %> - Tuần <%= week %> - <%= dayName %>',
            isExisting: true,
            detail: <%- JSON.stringify(dayDetails.map(d => ({
                id: d.menu_time_id,
                name: d.menu_time_name,
                courses: d.detail.courses || [],
                listFood: d.detail.listFood || []
            }))) %>
        }];

        // Ensure courses and course_id exist
        window.menuExamine.forEach(m => {
            if(m.detail && m.detail.length > 0){
                m.detail.forEach(mt => {
                    if(!mt.courses || mt.courses.length == 0){
                        mt.courses = [{ id: 1, name: mt.name_course || '' }];
                    }
                    if(mt.listFood && mt.listFood.length > 0){
                        mt.listFood.forEach(f => {
                            if(!f.course_id){
                                f.course_id = 1;
                            }
                        });
                    }
                });
            }
        });

        // Khởi tạo admin menu example
        $(document).ready(function() {
            initAdminMenuExample();

            generateFoodName("food_name");

            // Tạo column selector
            createColumnSelector();

            // Load cấu hình cột mặc định cho admin (không có patient_id)
            currentDisplayConfig = {
                visible_columns: ["weight", "energy", "protein", "fat", "carbohydrate"]
            };

            // Cập nhật header với cấu hình mặc định
            updateTableHeaderWithConfig();

            // Generate table for menu
            $('#tb_menu tbody').empty();
            $('#tb_menu').show();
            generateTableMenu(1);

            // Load dish categories cho phần thêm món ăn
            loadDishCategoriesForAddDish();
        });

        // Load dish categories
        function loadDishCategoriesForAddDish() {
            $.ajax({
                url: '/api/menu-build/dish-categories',
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        const categories = response.data.map(c => ({
                            label: c.name,
                            value: c.key
                        }));

                        // Setup virtual select cho dish_category
                        if (document.querySelector('#dish_category')) {
                            VirtualSelect.init({
                                ele: '#dish_category',
                                options: categories,
                                placeholder: 'Chọn loại món',
                                search: true
                            });

                            // Event khi chọn category
                            document.querySelector('#dish_category').addEventListener('change', function() {
                                loadDishesForAddDish();
                            });
                        }
                    }
                }
            });
        }

        // Load dishes theo category
        function loadDishesForAddDish() {
            const categoryKey = document.querySelector('#dish_category')?.value;
            if (!categoryKey) {
                return;
            }

            $.ajax({
                url: '/api/dishes-for-select-by-category?category=' + encodeURIComponent(categoryKey),
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        const dishes = response.data.map(d => ({
                            label: d.label,
                            value: d.value,
                            customData: d
                        }));

                        // Update virtual select cho dish_name
                        if (document.querySelector('#dish_name')) {
                            // Destroy old instance if exists
                            if (window.dishNameVS) {
                                window.dishNameVS.destroy();
                            }

                            window.dishNameVS = VirtualSelect.init({
                                ele: '#dish_name',
                                options: dishes,
                                placeholder: 'Chọn món ăn',
                                search: true
                            });
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading dishes:', error);
                    toarstError('Không thể tải danh sách món ăn');
                }
            });
        }

        // Override saveMenuExample to save to menu_build
        window.saveMenuBuildDay = async function() {
            try {
                // Get current menu data
                const currentMenu = menuExamine[0];
                if (!currentMenu || !currentMenu.detail) {
                    Swal.fire('Lỗi', 'Không có dữ liệu để lưu', 'error');
                    return;
                }

                // Prepare details array for each meal time
                const existingDetails = <%- JSON.stringify(dayDetails) %>;
                const details = currentMenu.detail.map(mealTime => {
                    // Find existing detail record
                    const existingDetail = existingDetails.find(d => d.menu_time_id === mealTime.id);

                    return {
                        existing_id: existingDetail ? existingDetail.id : null,
                        week_number: weekNumber,
                        day_of_week: dayOfWeek,
                        menu_time_id: mealTime.id,
                        detail: JSON.stringify({
                            courses: mealTime.courses || [],
                            listFood: mealTime.listFood || []
                        }),
                        note: null
                    };
                });

                const data = {
                    id: menuBuildId,
                    details: details,
                    detail_id_remove: []
                };

                const response = await $.ajax({
                    url: '/menu-build/save',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data)
                });

                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Lưu thành công',
                        text: 'Chi tiết ngày đã được cập nhật'
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    Swal.fire('Lỗi', response.message, 'error');
                }

            } catch (error) {
                console.error('Error saving:', error);
                Swal.fire('Lỗi', 'Có lỗi xảy ra khi lưu', 'error');
            }
        };
    </script>



</body>

</html>